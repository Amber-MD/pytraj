name: Python Package using Conda

on: [push]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 5

    steps:
    - name: Install prerequisite packages
      run: |
        sudo apt-get install gfortran
        sudo apt-get install libbz2-dev
        sudo apt-get install libblas-dev liblapack-dev
        sudo apt-get install libfftw3-dev
        sudo apt-get install clang
        sudo apt-get install cmake-data cmake    
    - uses: actions/checkout@v2
    - name: Set up Python 3.8
      uses: actions/setup-python@v2
      with:
        python-version: 3.8
    - name: Add conda to system path
      run: |
        # $CONDA is an environment variable pointing to the root of the miniconda directory
        echo $CONDA/bin >> $GITHUB_PATH
    - name: Install dependencies
      run: |
        curl -OL ftp://ftp.unidata.ucar.edu/pub/netcdf/netcdf-4.6.1.tar.gz
        tar -zxf netcdf-4.6.1.tar.gz
        cd netcdf-4.6.1
        ./configure --disable-netcdf-4 --disable-dap --disable-doxygen --prefix=$HOME
        make -j2
        make install
        cd ..
        export PATH=$HOME/bin:$PATH
    - name: Install conda packages
      run: |
        conda env update --file environment.yml --name base        
    - name: Install cpptraj
      run: |
        git clone https://github.com/Amber-MD/cpptraj
        cd cpptraj
        export CPPTRAJHOME=`pwd`
        yes | ./configure -shared gnu
        make libcpptraj
        cd ../
    - name: Install pytraj
      run: |        
        python setup.py install
        # - name: Lint with flake8
        #   run: |
        #     conda install flake8
        #     # stop the build if there are Python syntax errors or undefined names
        #     flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        #     # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
        #     flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    - name: Test with pytest
      run: |
        conda install pytest
        python run_tests.py
